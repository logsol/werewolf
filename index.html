<!DOCTYPE html>
<html>
<head>
  <title>Werewolf</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<div id="container" class="clearfix">

  <div id="selection">
    <div id="selalign">
      <span class="name"></span>
      <span class="role">üåÄ</span>
    </div>
  </div>

  <div id="prejoin">
    Name: <input id="name" value=""/>
    <button id="join">Join</button>
  </div>
	<button id="newgame">Create a new game</button>
  
  <div id="game">
    <span id="role"></span>
    <span id="state"></span>
    <ul id="players"></ul>
    <button id="progress">?</button>
  </div>

</div>

</body>
</html>

<script>

var STATE_WAIT = 'wait';
var STATE_PREPARE = 'prepare';
var STATE_SLEEP = 'sleep';
var STATE_SEER = 'seer';
var STATE_WITCH = 'witch';
var STATE_WOLFS = 'wolfs';
var STATE_WAKE = 'wake';

var socket = io();
var inGame = location.href.includes("#");
var isHost = false;
var role = undefined;

socket.on('connect', function () {
	if (inGame) {
    $("#newgame").hide();
    $("#prejoin").show();
	}
});

socket.on('disconnect', function () {
  location.reload();
});

socket.on('deprecated', function () {
  window.alert("You are playing in another window now.");
  location.href = "/";
});

socket.on('generated', function(msg){
	if (!inGame) {
		location.href += "#" + msg;
		location.reload();
	}
});

socket.on('created', function(msg){
  // nothing to do here
});

socket.on('host', function(msg){
  isHost = true;
  $("#players").addClass('hostview')
  $("#progress").show();
  $("#prejoin").hide();
});

socket.on('joined', function(msg){
  $("#prejoin").hide();
  $("#game").show();
});

socket.on('presence', function(msg){
  var players = JSON.parse(msg);
  $("#players").empty();
  for (var x in players) {
    var player = players[x];

    var liHtml = "";
    liHtml += '<li id="' + x + '">'
    liHtml += '<div class="name">' + player.nm + '</div>';
    liHtml += '<span class="role">üåÄ</span>';
    liHtml += '<span class="reveal"></span>';
    liHtml += '<span class="disconnected">üîå</span>';
    liHtml +=  "</li>";

    var li = $(liHtml);

    if(isHost && role) {
      if (!player.hs) {
        var kill = $('<button class="kill">kill</button>');
        var revive = $('<button class="revive">revive</button>');
        if (player.vc) {
          li.append(revive);
        } else {
          if (!player.dd) {
            li.append(kill);
          }
        }
      }
    }
    
    $("#players").append(li);

    if (!player.cn) {
      $('.disconnected', li).show();
    }
    if (player.rv && !player.hs) {
      $('.reveal', li).show();
      $('.reveal', li).text(player.rv); 
    }
    if (player.dd) {
      $('.role', li).text("‚ö∞Ô∏è");
    }
    if (player.vc) {
      $('.role', li).text("‚ò†Ô∏è");
    }
    if (player.hs) {
      $('.role', li).text("üó£");
    }
    if (player.iy) {
      $('.name', li).addClass('you');
    }
    if (player.iy) {
      if (player.dd) {
        $('#role').text("‚ö∞Ô∏è");
      }
    }
  }
});

socket.on('state', function(msg) {
  var state = JSON.parse(msg);
  $("#state").text(state);
});

socket.on('role', function(msg) {
  role = JSON.parse(msg);
  $("#role").text(role);
  $("#game").show();
});

socket.on('action', function(msg) {
  $("#progress").text(msg);
});

// socket.on('wolfinfo', function(msg) {
//   var wolfinfo = JSON.parse(msg);
//   for (var x in wolfinfo.wolfs) {
//     var wf = wolfinfo.wolfs[x].wf;
//     $("#players li").foreach(function(i, el) {
//       if (i == wf) {
//         el.addClass('wolf');
//       }
//     });
//   }
// });

$(document).ready(function() {
  // WINDOW
  $(window).on('hashchange', function(e) {
    location.reload();
  });

  // CLICKS
  $("#newgame").click(function(){
    socket.emit('newgame');
  });

  $("#join").click(function(){
    var name = $("#name").val();
    socket.emit('join', location.hash.substr(1), name);
  });

  $("body").on('keypress', function (e) {
    if(e.which == 13) {
      
      $("#name").blur();

      if ($("#join").is(":visible")) {
        $("#join").trigger("click");
      } 
      if ($("#progress").is(":visible")) {
        $("#progress").trigger("click");
      }
    }
  });

  // HOST CLICKS
  $("#progress").click(function(){
    socket.emit('progress');
  });

  $("#players").on('click', '.kill', function(e){
    var index = $(e.target).parent().attr('id');
    socket.emit('kill', index);
    e.stopPropagation();
  });

  $("#players").on('click', '.revive', function(e){
    var index = $(e.target).parent().attr('id');
    socket.emit('revive', index);
    e.stopPropagation();
  });

  $("#players").on('click', function(e){
    var li = $(e.target).closest("li");
    var name = $(".name", li).text();
    var role = $(".role", li).text();

    if (role == "üåÄ") {
      $("#selection .name").text(name);
      $("#selection .role").text(role);
      $("#selection").show();
    }
  });

  $("#selection").click(function(){
    $("#selection").hide();
  });

  function init() {
    var preset = window.location.search.substr(1);
    if (preset) {
      $("#name").val(preset);
      $("#join").trigger("click");
    } else {
      $("#name").focus();
    }
  }
  init();
});

</script>