<!DOCTYPE html>
<html>
<head>
<title>Werwolf</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<style type="text/css">
  body {
    background-color: #444;
    color: #bbb;
  }
  #join, #start {
    display: none;
  }
  .connected {
    color: green;
  }
</style>
</head>
<body>
<h1>Werwolf</h1>

<div id="config">
  <p>Name: <input id="name" value="Karl"/></p>
	<button id="newgame">Start a new game</button>
  <button id="join">Join</button>
  <p id="wait">
    <p id="state"></p>
    <ul id="players"></ul>
    <button id="start">Start Game</button>
  </p>
</div>

</body>
</html>

<script>

var socket = io();
var inGame = location.href.includes("#");
var isHost = false;

socket.on('connect', function () {
	if (inGame) {
    $("#newgame").hide();
    $("#join").show();
	}
});

socket.on('deprecated', function () {
  console.log("You are playing in another window now.");
  alert("You are playing in another window now.");
  location.href = "/";
});

socket.on('generated', function(msg){
	console.log("generated: " + msg)
	if (!inGame) {
		location.href += "#" + msg;
		location.reload();
	}
});

socket.on('created', function(msg){
  isHost = true;
  $("#start").show();
});

socket.on('joined', function(msg){
  $("#join").hide();
});

socket.on('presence', function(msg){
  var players = JSON.parse(msg);
  $("#players").empty();
  for (var x in players) {
    var player = players[x];
    var connectedClass = player.cn ? 'connected' : '';
    $("#players").append($("<li>" + player.nm + "</li>").addClass(connectedClass));
  }
});

socket.on('state', function(msg){
  var state = JSON.parse(msg);
  $("#state").text(state);
});

// WINDOW
$(window).on('hashchange', function(e) {
  location.reload();
});

// CLICKS
$("#newgame").click(function(){
	socket.emit('newgame');
});

$("#join").click(function(){
  var name = $("#name").val();
  socket.emit('join', location.hash.substr(1), name);
});

$("#start").click(function(){
  socket.emit('start');
});
</script>