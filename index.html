<!DOCTYPE html>
<html>
<head>
<title>Werwolf</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<style type="text/css">
  body {
    background-color: #444;
    color: #bbb;
  }
  #join, #start, #game, #dead {
    display: none;
  }
  .connected {
    color: green;
  }
  .dead::after {
    content: " ⚰️";
  }
  .you {
    color: lime;
  }
  .host::after {
    content: " (host)";
  }
  #role, #dead {
    font-size: 3em;
  }
</style>
</head>
<body>
<h1>Werwolf</h1>

<div id="config">
  <p id="prejoin">
    Name: <input id="name" value="Karl"/>
    <button id="join">Join</button>
  </p>
	<button id="newgame">Start a new game</button>
  
  <p id="wait">
    <p id="state"></p>
    <ul id="players"></ul>
    <button id="start">Start Game</button>
  </p>
  <p id="game">
    <span id="role"></span>
    <span id="dead">⚰️</span>
  </p>
</div>

</body>
</html>

<script>

var socket = io();
var inGame = location.href.includes("#");
var isHost = false;

socket.on('connect', function () {
	if (inGame) {
    $("#newgame").hide();
    $("#join").show();
	}
});

socket.on('disconnect', function () {
  location.reload();
});

socket.on('deprecated', function () {
  console.log("You are playing in another window now.");
  window.alert("You are playing in another window now.");
  location.href = "/";
});

socket.on('generated', function(msg){
	console.log("generated: " + msg)
	if (!inGame) {
		location.href += "#" + msg;
		location.reload();
	}
});

socket.on('created', function(msg){
  // nothing to do here
});

socket.on('host', function(msg){
  isHost = true;
  $("#start").show();
});

socket.on('joined', function(msg){
  $("#prejoin").hide();
});

socket.on('presence', function(msg){
  var players = JSON.parse(msg);
  $("#players").empty();
  for (var x in players) {
    var player = players[x];

    var li = $("<li>" + player.nm + "</li>");
    if (player.cn) {
      li.addClass('connected');
    }
    if (player.dd) {
      li.addClass('dead');
    }
    if (player.hs) {
      li.addClass('host');
    }
    if (player.iy) {
      li.addClass('you');
    }
    if (player.iy && player.dd) {
      $("#dead").show();
    }
    
    $("#players").append(li);
  }
});

socket.on('state', function(msg) {
  var state = JSON.parse(msg);
  $("#state").text(state);
});

socket.on('role', function(msg) {
  var role = JSON.parse(msg);
  $("#role").text(role);

  $("#game").show();
  $("#start").hide();
});

// WINDOW
$(window).on('hashchange', function(e) {
  location.reload();
});

// CLICKS
$("#newgame").click(function(){
	socket.emit('newgame');
});

$("#join").click(function(){
  var name = $("#name").val();
  socket.emit('join', location.hash.substr(1), name);
});

$("#start").click(function(){
  socket.emit('start');
});

function init() {
  var preset = location.host.split(".")[0];
  if (!preset.includes("localhost")) {
    $("#name").val(preset);
  }

}
init()
</script>