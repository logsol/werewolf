<!DOCTYPE html>
<html>
<head>
<title>Werwolf</title>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<style type="text/css">
  body {
    background-color: #444;
    color: #bbb;
  }
  #progress, #game, #dead, #prejoin {
    display: none;
  }
  .connected {
    color: green;
  }
  .dead::after {
    content: " ‚ö∞Ô∏è";
  }
  .you {
    color: lime;
  }
  .host::before {
    content: "üïπ";
  }
  .wolf::before {
    content: "üê∫";
  }
  #role, #dead {
    font-size: 3em;
  }
  .kill, .revive {
    width: 50px;
  }
</style>
</head>
<body>

<div id="config">
  <p id="prejoin">
    Name: <input id="name" value="Karl"/>
    <button id="join">Join</button>
  </p>
	<button id="newgame">Create a new game</button>
  
  <p id="wait">
    <p id="state"></p>
    <ul id="players"></ul>
    <button id="progress">?</button>
  </p>
  <p id="game">
    <span id="role"></span>
    <span id="dead">‚ö∞Ô∏è</span>
  </p>
</div>

</body>
</html>

<script>

var STATE_WAIT = 'wait';
var STATE_PREPARE = 'prepare';
var STATE_SLEEP = 'sleep';
var STATE_SEER = 'seer';
var STATE_WITCH = 'witch';
var STATE_WOLFS = 'wolfs';
var STATE_WAKE = 'wake';

var socket = io();
var inGame = location.href.includes("#");
var isHost = false;
var role = undefined;

socket.on('connect', function () {
	if (inGame) {
    $("#newgame").hide();
    $("#prejoin").show();
	}
});

socket.on('disconnect', function () {
  location.reload();
});

socket.on('deprecated', function () {
  console.log("You are playing in another window now.");
  window.alert("You are playing in another window now.");
  location.href = "/";
});

socket.on('generated', function(msg){
	console.log("generated: " + msg)
	if (!inGame) {
		location.href += "#" + msg;
		location.reload();
	}
});

socket.on('created', function(msg){
  // nothing to do here
});

socket.on('host', function(msg){
  isHost = true;
  $("#progress").show();
  $("#prejoin").hide();
});

socket.on('joined', function(msg){
  $("#prejoin").hide();
});

socket.on('presence', function(msg){
  var players = JSON.parse(msg);
  $("#players").empty();
  for (var x in players) {
    var player = players[x];

    var liHtml = '<li id="' + x + '"> ' + player.nm + "</li>"

    var li = $(liHtml);
    if (player.cn) {
      li.addClass('connected');
    }
    if (player.dd) {
      li.addClass('dead');
    }
    if (player.hs) {
      li.addClass('host');
    }
    if (player.iy) {
      li.addClass('you');
    }
    if (player.iy) {
      if (player.dd) {
        $("#dead").show();
      } else {
        $("#dead").hide();
      }
    }

    if(isHost) {
      if (!player.hs) {
        var kill = $('<button class="kill">kill</button>');
        var revive = $('<button class="revive">revive</button>');
        if (player.dd) {
          li.prepend(revive);
        } else {
          li.prepend(kill);
        }
      }
    }
    
    $("#players").append(li);
  }
});

socket.on('state', function(msg) {
  var state = JSON.parse(msg);
  $("#state").text(state);
});

socket.on('role', function(msg) {
  role = JSON.parse(msg);
  $("#role").text(role);
  $("#game").show();
});

socket.on('action', function(msg) {
  $("#progress").text(msg);
  $("#progress").show();
});

// socket.on('wolfinfo', function(msg) {
//   var wolfinfo = JSON.parse(msg);
//   for (var x in wolfinfo.wolfs) {
//     var wf = wolfinfo.wolfs[x].wf;
//     $("#players li").foreach(function(i, el) {
//       if (i == wf) {
//         el.addClass('wolf');
//       }
//     });
//   }
// });

$(document).ready(function() {
  // WINDOW
  $(window).on('hashchange', function(e) {
    location.reload();
  });

  // CLICKS
  $("#newgame").click(function(){
    socket.emit('newgame');
  });

  $("#join").click(function(){
    var name = $("#name").val();
    socket.emit('join', location.hash.substr(1), name);
  });

  // HOST CLICKS
  $("#progress").click(function(){
    socket.emit('progress');
    $("#progress").hide();
  });

  $("#players").on('click', '.kill', function(e){
    var index = $(e.target).parent().attr('id');
    socket.emit('kill', index);
  });

  $("#players").on('click', '.revive', function(e){
    var index = $(e.target).parent().attr('id');
    socket.emit('revive', index);
  });

  function init() {
    var preset = location.host.split(".")[0];
    if (!preset.includes("localhost")) {
      $("#name").val(preset);
    }
  }
  init();
});

</script>